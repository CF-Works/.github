name: è‡ªåŠ¨åŒæ­¥é¡¹ç›®åˆ—è¡¨

on:
  workflow_dispatch:
  repository_dispatch:
    types: [org-webhook]

# ä¸‹é¢æ˜¯å…·ä½“çš„ä»»åŠ¡ä»£ç ...

# ğŸ”’ æœ€å°æƒé™åŸåˆ™ï¼ˆæŒ‰éœ€å¼€å¯ï¼‰
permissions:
  contents: read
  issues: write    # å¦‚éœ€è‡ªåŠ¨åˆ›å»º Issue
  pull-requests: write # å¦‚éœ€è¯„è®º PR

jobs:
  process:
    name: å¤„ç† ${{ github.event.client_payload.github_event }} @ ${{ github.event.client_payload.repo }}
    runs-on: ubuntu-latest
    env:
      EVENT_REPO: ${{ github.event.client_payload.repo }}
      EVENT_ACTION: ${{ github.event.client_payload.action }}
      EVENT_TYPE: ${{ github.event.client_payload.github_event }}
      EVENT_SENDER: ${{ github.event.client_payload.sender }}
    
    steps:
      # ğŸ” 1. å®‰å…¨éªŒè¯ï¼šä»…å¤„ç† CF-Works ç»„ç»‡ä»“åº“äº‹ä»¶
      - name: éªŒè¯æ¥æºç»„ç»‡
        run: |
          if [[ ! "$EVENT_REPO" =~ ^CF-Works/ ]]; then
            echo "âš ï¸ æ‹’ç»é CF-Works ä»“åº“äº‹ä»¶: $EVENT_REPO"
            exit 1
          fi
          echo "âœ… äº‹ä»¶æ¥æºéªŒè¯é€šè¿‡: $EVENT_REPO"

      # ğŸ“¦ 2. æ‰“å°ç»“æ„åŒ–æ—¥å¿—ï¼ˆè°ƒè¯•ç¥å™¨ï¼‰
      - name: æ˜¾ç¤ºäº‹ä»¶è¯¦æƒ…
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ ä»“åº“: $EVENT_REPO"
          echo "âš¡ äº‹ä»¶ç±»å‹: $EVENT_TYPE ($EVENT_ACTION)"
          echo "ğŸ‘¤ è§¦å‘è€…: $EVENT_SENDER"
          echo "ğŸ•’ å¤„ç†æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¡ æç¤º: åœ¨ Actions æ—¥å¿—ä¸­æœç´¢ 'ğŸ“' å¿«é€Ÿå®šä½äº‹ä»¶"

      # ğŸŒ° 3. æ™ºèƒ½å“åº”ç¤ºä¾‹ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
      - name: ğŸ“Œ ä¸ºå« "security" çš„ä»“åº“åˆ›å»ºå®‰å…¨å¤æŸ¥ Issue
        if: ${{ contains(env.EVENT_REPO, 'security') && env.EVENT_TYPE == 'push' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ğŸ” å®‰å…¨å¤æŸ¥: ${{ env.EVENT_REPO }} æ–°æ¨é€"
          content: |
            **ä»“åº“**: `${{ env.EVENT_REPO }}`  
            **æ¨é€è€…**: `${{ env.EVENT_SENDER }}`  
            **æ—¶é—´**: `${{ github.event.client_payload.timestamp }}`  
            **å»ºè®®**: æ£€æŸ¥æœ¬æ¬¡æ¨é€æ˜¯å¦å«æ•æ„Ÿé…ç½®/ä¾èµ–æ¼æ´  
            ---
            *ç”± CF-Works ç»„ç»‡äº‹ä»¶ä¸­æ¢è‡ªåŠ¨åˆ›å»º | [æŸ¥çœ‹ Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: security, auto-created

      - name: ğŸ’¬ åœ¨ PR æ‰“å¼€æ—¶è‡ªåŠ¨è¯„è®ºï¼ˆç¤ºä¾‹ï¼‰
        if: ${{ env.EVENT_TYPE == 'pull_request' && env.EVENT_ACTION == 'opened' }}
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ğŸŒ **CF-Works ç»„ç»‡è§„èŒƒæé†’**  
            æ‚¨çš„ PR å·²è¢«ç»„ç»‡äº‹ä»¶ä¸­æ¢æ•è·ï¼  
            âœ… è¯·ç¡®è®¤ï¼š  
            - [ ] å·²é€šè¿‡å®‰å…¨æ‰«æ  
            - [ ] ç¬¦åˆç»„ç»‡ä»£ç è§„èŒƒ  
            *ï¼ˆæ­¤è¯„è®ºç”±è‡ªåŠ¨åŒ–æµç¨‹ç”Ÿæˆï¼‰*
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ§ª 4. æœ¬åœ°æµ‹è¯•å‘½ä»¤ï¼ˆæ— éœ€ç­‰å¾…çœŸå®äº‹ä»¶ï¼ï¼‰
      # åœ¨ä¸­å¤®ä»“åº“ç›®å½•æ‰§è¡Œï¼š
      # gh workflow run listen.yml -f event_type=org-webhook -f client_payload='{"repo":"CF-Works/test-repo","action":"push","sender":"test","github_event":"push","timestamp":"2024-06-15T10:00:00Z"}'