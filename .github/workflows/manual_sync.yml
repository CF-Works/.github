name: 同步组织项目集

on:
  workflow_dispatch: # 支持手动点击运行
  # 如果你想每天自动运行一次，可以取消下面两行的注释
  # schedule:
  #   - cron: '0 0 * * *'

jobs:
  update-config:
    runs-on: ubuntu-latest
    # 授予读写权限，允许 Action 修改代码并推送
    permissions:
      contents: write

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 获取并处理仓库数据
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: ${{ github.repository_owner }}
        run: |
          # 1. 使用 GitHub CLI 获取公开仓库数据
          # 获取字段：名称、链接、描述、官网链接
          echo "正在获取 $ORG_NAME 的公开仓库列表..."
          export REPOS_JSON=$(gh repo list $ORG_NAME --visibility=public --json name,url,description,homepageUrl --limit 100)

          # 2. 使用 Node.js 脚本处理逻辑并更新 config.js
          node -e "
            try {
              const fs = require('fs');
              const repos = JSON.parse(process.env.REPOS_JSON);
              const owner = process.env.ORG_NAME;

              if (!Array.isArray(repos)) {
                console.error('API 返回数据格式错误');
                process.exit(1);
              }

              // 数据转换逻辑
              const projects = repos
                .filter(r => r.name !== '.github' && r.name !== owner) // 排除管理库
                .map(r => {
                  const links = [];
                  // 优先添加 Website (homepageUrl)
                  if (r.homepageUrl && r.homepageUrl.trim() !== '') {
                    links.push({ 
                      url: r.homepageUrl, 
                      display: r.homepageUrl.replace(/^https?:\/\//, '').replace(/\/$/, '') 
                    });
                  }
                  // 添加 GitHub 仓库链接
                  links.push({ 
                    url: r.url, 
                    display: r.url.replace('https://github.com/', '') 
                  });
                  
                  return {
                    title: r.name,
                    links: links,
                    description: r.description || '暂无项目描述'
                  };
                });

              // 读取 config.js
              const configPath = 'config.js';
              if (!fs.existsSync(configPath)) {
                console.error('未找到 config.js 文件');
                process.exit(1);
              }

              let content = fs.readFileSync(configPath, 'utf8');
              const projectsString = JSON.stringify(projects, null, 2);
              
              // 正则匹配并替换 projects 数组
              // 匹配模式：projects: [ 到 ] 之间的内容
              const newContent = content.replace(/projects: \[\s*[\s\S]*?\s*\]/, 'projects: ' + projectsString);
              
              fs.writeFileSync(configPath, newContent);
              console.log('✅ 成功更新 ' + projects.length + ' 个项目到 config.js');
            } catch (err) {
              console.error('❌ 执行出错:', err.message);
              process.exit(1);
            }
          "

      - name: 提交并推送到仓库
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add config.js
          # 如果没有变化，则不报错退出
          git commit -m "auto: 同步组织仓库列表" || exit 0
          git push
